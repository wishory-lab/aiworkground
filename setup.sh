# WorkflowAI Environment Setup Script
#!/bin/bash

set -e  # Exit on any error

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m' # No Color

# Configuration
PROJECT_DIR="$(pwd)"
ENV_FILE=".env"
SUPABASE_DIR="./supabase"
VENV_DIR="./backend/venv"

echo -e "${BLUE}ðŸ—ï¸  WorkflowAI í™˜ê²½ ì„¤ì • ìŠ¤í¬ë¦½íŠ¸${NC}"
echo -e "${BLUE}=======================================${NC}"
echo ""

# Function to prompt for user input with validation
prompt_for_input() {
    local var_name=$1
    local prompt_message=$2
    local default_value=$3
    local validation_pattern=$4
    
    while true; do
        if [ ! -z "$default_value" ]; then
            echo -e "${YELLOW}$prompt_message (ê¸°ë³¸ê°’: $default_value):${NC}"
        else
            echo -e "${YELLOW}$prompt_message:${NC}"
        fi
        
        read -r input
        
        # Use default if input is empty
        if [ -z "$input" ] && [ ! -z "$default_value" ]; then
            input=$default_value
        fi
        
        # Validate input if pattern provided
        if [ ! -z "$validation_pattern" ]; then
            if [[ $input =~ $validation_pattern ]]; then
                echo "$input"
                return 0
            else
                echo -e "${RED}âŒ ìž˜ëª»ëœ í˜•ì‹ìž…ë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.${NC}"
                continue
            fi
        fi
        
        if [ ! -z "$input" ]; then
            echo "$input"
            return 0
        else
            echo -e "${RED}âŒ ê°’ì„ ìž…ë ¥í•´ì£¼ì„¸ìš”.${NC}"
        fi
    done
}

# Function to generate secure random string
generate_secret() {
    openssl rand -hex 32
}

# Check prerequisites
echo -e "${BLUE}ðŸ“‹ ì‚¬ì „ ìš”êµ¬ì‚¬í•­ í™•ì¸ ì¤‘...${NC}"

# Check Node.js
if ! command -v node &> /dev/null; then
    echo -e "${RED}âŒ Node.jsê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. https://nodejs.orgì—ì„œ ì„¤ì¹˜í•´ì£¼ì„¸ìš”.${NC}"
    exit 1
fi
echo -e "${GREEN}âœ… Node.js $(node --version) í™•ì¸ë¨${NC}"

# Check Python
if ! command -v python3 &> /dev/null; then
    echo -e "${RED}âŒ Python 3ì´ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.${NC}"
    exit 1
fi
echo -e "${GREEN}âœ… Python $(python3 --version) í™•ì¸ë¨${NC}"

# Check Docker (optional)
if command -v docker &> /dev/null; then
    echo -e "${GREEN}âœ… Docker $(docker --version) í™•ì¸ë¨${NC}"
else
    echo -e "${YELLOW}âš ï¸  Dockerê°€ ì—†ìŠµë‹ˆë‹¤. ë¡œì»¬ ê°œë°œì€ ê°€ëŠ¥í•˜ì§€ë§Œ í”„ë¡œë•ì…˜ ë°°í¬ì— í•„ìš”í•©ë‹ˆë‹¤.${NC}"
fi

echo ""

# Create environment file
echo -e "${BLUE}ðŸ”§ í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ì¤‘...${NC}"

if [ -f "$ENV_FILE" ]; then
    echo -e "${YELLOW}âš ï¸  ê¸°ì¡´ .env íŒŒì¼ì´ ìžˆìŠµë‹ˆë‹¤. ë°±ì—… ì¤‘...${NC}"
    cp "$ENV_FILE" "${ENV_FILE}.backup.$(date +%Y%m%d_%H%M%S)"
fi

echo "# WorkflowAI Environment Variables - Generated $(date)" > "$ENV_FILE"
echo "# Auto-generated by setup script" >> "$ENV_FILE"
echo "" >> "$ENV_FILE"

# Application Settings
echo "=== ê¸°ë³¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì • ===" 
echo ""

NEXT_PUBLIC_APP_URL=$(prompt_for_input "NEXT_PUBLIC_APP_URL" "ì• í”Œë¦¬ì¼€ì´ì…˜ URL" "http://localhost:3000")
API_BASE_URL=$(prompt_for_input "API_BASE_URL" "ë°±ì—”ë“œ API URL" "http://localhost:8000")
ENVIRONMENT=$(prompt_for_input "ENVIRONMENT" "ì‹¤í–‰ í™˜ê²½" "development")

echo "" >> "$ENV_FILE"
echo "# === APPLICATION ===" >> "$ENV_FILE"
echo "NEXT_PUBLIC_APP_URL=$NEXT_PUBLIC_APP_URL" >> "$ENV_FILE"
echo "API_BASE_URL=$API_BASE_URL" >> "$ENV_FILE"
echo "ENVIRONMENT=$ENVIRONMENT" >> "$ENV_FILE"
echo "LOG_LEVEL=info" >> "$ENV_FILE"

# Database Configuration
echo ""
echo -e "${PURPLE}ðŸ“Š ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •${NC}"
echo "Supabase í”„ë¡œì íŠ¸ê°€ í•„ìš”í•©ë‹ˆë‹¤: https://supabase.com"
echo ""

echo -e "${YELLOW}Supabase ëŒ€ì‹œë³´ë“œì—ì„œ ë‹¤ìŒ ì •ë³´ë¥¼ ê°€ì ¸ì™€ì£¼ì„¸ìš”:${NC}"
SUPABASE_URL=$(prompt_for_input "SUPABASE_URL" "Supabase Project URL" "" "^https://.*\.supabase\.co$")
SUPABASE_ANON_KEY=$(prompt_for_input "SUPABASE_ANON_KEY" "Supabase Anon Key")
SUPABASE_SERVICE_KEY=$(prompt_for_input "SUPABASE_SERVICE_KEY" "Supabase Service Role Key")

echo "" >> "$ENV_FILE"
echo "# === DATABASE ===" >> "$ENV_FILE"
echo "SUPABASE_URL=$SUPABASE_URL" >> "$ENV_FILE"
echo "SUPABASE_ANON_KEY=$SUPABASE_ANON_KEY" >> "$ENV_FILE"
echo "SUPABASE_SERVICE_KEY=$SUPABASE_SERVICE_KEY" >> "$ENV_FILE"
echo "DATABASE_URL=${SUPABASE_URL/https:\/\//postgres://postgres:[YOUR_PASSWORD]@}/postgres" >> "$ENV_FILE"

# Authentication (Clerk)
echo ""
echo -e "${PURPLE}ðŸ” ì¸ì¦ ì„¤ì • (Clerk)${NC}"
echo "Clerk ëŒ€ì‹œë³´ë“œ: https://clerk.com"
echo ""

CLERK_SECRET_KEY=$(prompt_for_input "CLERK_SECRET_KEY" "Clerk Secret Key")
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=$(prompt_for_input "NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY" "Clerk Publishable Key")

echo "" >> "$ENV_FILE"
echo "# === AUTHENTICATION ===" >> "$ENV_FILE"
echo "CLERK_SECRET_KEY=$CLERK_SECRET_KEY" >> "$ENV_FILE"
echo "NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=$NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY" >> "$ENV_FILE"
echo "NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in" >> "$ENV_FILE"
echo "NEXT_PUBLIC_CLERK_SIGN_UP_URL=/sign-up" >> "$ENV_FILE"
echo "NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL=/dashboard" >> "$ENV_FILE"
echo "NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL=/dashboard" >> "$ENV_FILE"

# AI APIs
echo ""
echo -e "${PURPLE}ðŸ¤– AI API ì„¤ì •${NC}"
echo ""

echo -e "${YELLOW}OpenAI API Key (GPT-4, DALL-E):${NC}"
OPENAI_API_KEY=$(prompt_for_input "OPENAI_API_KEY" "OpenAI API Key" "" "^sk-")

echo -e "${YELLOW}Anthropic API Key (Claude):${NC}"
ANTHROPIC_API_KEY=$(prompt_for_input "ANTHROPIC_API_KEY" "Anthropic API Key")

echo -e "${YELLOW}Midjourney API Key (ì„ íƒì‚¬í•­):${NC}"
read -r -p "Midjourney API Key (Enterë¡œ ê±´ë„ˆë›°ê¸°): " MIDJOURNEY_API_KEY

echo "" >> "$ENV_FILE"
echo "# === AI APIS ===" >> "$ENV_FILE"
echo "OPENAI_API_KEY=$OPENAI_API_KEY" >> "$ENV_FILE"
echo "ANTHROPIC_API_KEY=$ANTHROPIC_API_KEY" >> "$ENV_FILE"
echo "MIDJOURNEY_API_KEY=$MIDJOURNEY_API_KEY" >> "$ENV_FILE"

# Payment (Stripe)
echo ""
echo -e "${PURPLE}ðŸ’³ ê²°ì œ ì„¤ì • (Stripe)${NC}"
echo "Stripe ëŒ€ì‹œë³´ë“œ: https://dashboard.stripe.com"
echo ""

STRIPE_SECRET_KEY=$(prompt_for_input "STRIPE_SECRET_KEY" "Stripe Secret Key" "" "^sk_")
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=$(prompt_for_input "NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY" "Stripe Publishable Key" "" "^pk_")
STRIPE_WEBHOOK_SECRET=$(prompt_for_input "STRIPE_WEBHOOK_SECRET" "Stripe Webhook Secret")

echo "" >> "$ENV_FILE"
echo "# === PAYMENT ===" >> "$ENV_FILE"
echo "STRIPE_SECRET_KEY=$STRIPE_SECRET_KEY" >> "$ENV_FILE"
echo "NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=$NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY" >> "$ENV_FILE"
echo "STRIPE_WEBHOOK_SECRET=$STRIPE_WEBHOOK_SECRET" >> "$ENV_FILE"

# Platform Integrations
echo ""
echo -e "${PURPLE}ðŸ”— í”Œëž«í¼ í†µí•© ì„¤ì •${NC}"
echo ""

# GitHub
echo -e "${YELLOW}GitHub App ì„¤ì • (ì„ íƒì‚¬í•­):${NC}"
read -r -p "GitHub App ID (Enterë¡œ ê±´ë„ˆë›°ê¸°): " GITHUB_APP_ID
read -r -p "GitHub Client ID (Enterë¡œ ê±´ë„ˆë›°ê¸°): " GITHUB_CLIENT_ID
read -r -p "GitHub Client Secret (Enterë¡œ ê±´ë„ˆë›°ê¸°): " GITHUB_CLIENT_SECRET

# Figma
echo -e "${YELLOW}Figma ì„¤ì • (ì„ íƒì‚¬í•­):${NC}"
read -r -p "Figma Client ID (Enterë¡œ ê±´ë„ˆë›°ê¸°): " FIGMA_CLIENT_ID
read -r -p "Figma Client Secret (Enterë¡œ ê±´ë„ˆë›°ê¸°): " FIGMA_CLIENT_SECRET

# Slack
echo -e "${YELLOW}Slack ì„¤ì • (ì„ íƒì‚¬í•­):${NC}"
read -r -p "Slack Client ID (Enterë¡œ ê±´ë„ˆë›°ê¸°): " SLACK_CLIENT_ID
read -r -p "Slack Client Secret (Enterë¡œ ê±´ë„ˆë›°ê¸°): " SLACK_CLIENT_SECRET

echo "" >> "$ENV_FILE"
echo "# === PLATFORM INTEGRATIONS ===" >> "$ENV_FILE"
echo "GITHUB_APP_ID=$GITHUB_APP_ID" >> "$ENV_FILE"
echo "GITHUB_CLIENT_ID=$GITHUB_CLIENT_ID" >> "$ENV_FILE"
echo "GITHUB_CLIENT_SECRET=$GITHUB_CLIENT_SECRET" >> "$ENV_FILE"
echo "FIGMA_CLIENT_ID=$FIGMA_CLIENT_ID" >> "$ENV_FILE"
echo "FIGMA_CLIENT_SECRET=$FIGMA_CLIENT_SECRET" >> "$ENV_FILE"
echo "SLACK_CLIENT_ID=$SLACK_CLIENT_ID" >> "$ENV_FILE"
echo "SLACK_CLIENT_SECRET=$SLACK_CLIENT_SECRET" >> "$ENV_FILE"

# Generate secure keys
echo ""
echo -e "${BLUE}ðŸ” ë³´ì•ˆ í‚¤ ìƒì„± ì¤‘...${NC}"

JWT_SECRET=$(generate_secret)
ENCRYPTION_KEY=$(generate_secret)

echo "" >> "$ENV_FILE"
echo "# === SECURITY ===" >> "$ENV_FILE"
echo "JWT_SECRET=$JWT_SECRET" >> "$ENV_FILE"
echo "ENCRYPTION_KEY=$ENCRYPTION_KEY" >> "$ENV_FILE"

# MCP Servers
echo "" >> "$ENV_FILE"
echo "# === MCP SERVERS ===" >> "$ENV_FILE"
echo "MCP_MARKETING_SERVER_URL=http://localhost:8001" >> "$ENV_FILE"
echo "MCP_DESIGN_SERVER_URL=http://localhost:8002" >> "$ENV_FILE"
echo "MCP_DEVELOPER_SERVER_URL=http://localhost:8003" >> "$ENV_FILE"

echo ""
echo -e "${GREEN}âœ… í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„± ì™„ë£Œ: $ENV_FILE${NC}"

# Install dependencies
echo ""
echo -e "${BLUE}ðŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘...${NC}"

echo "Frontend ì˜ì¡´ì„± ì„¤ì¹˜..."
npm install
echo -e "${GREEN}âœ… Frontend ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ${NC}"

# Python backend setup
echo ""
echo "Backend Python í™˜ê²½ ì„¤ì •..."
if [ ! -d "$VENV_DIR" ]; then
    python3 -m venv "$VENV_DIR"
    echo -e "${GREEN}âœ… Python ê°€ìƒí™˜ê²½ ìƒì„± ì™„ë£Œ${NC}"
fi

source "$VENV_DIR/bin/activate"
pip install --upgrade pip
pip install -r backend/requirements.txt
echo -e "${GREEN}âœ… Backend ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ${NC}"

# Database setup
echo ""
echo -e "${BLUE}ðŸ—„ï¸  ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •${NC}"

if [ -f "database/schema.sql" ]; then
    echo -e "${YELLOW}ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆë¥¼ Supabaseì— ì ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n)${NC}"
    read -r apply_schema
    
    if [[ $apply_schema =~ ^[Yy]$ ]]; then
        echo "Supabase CLIë¥¼ ì‚¬ìš©í•˜ì—¬ ìŠ¤í‚¤ë§ˆë¥¼ ì ìš©í•˜ì„¸ìš”:"
        echo "1. Supabase CLI ì„¤ì¹˜: npm install -g supabase"
        echo "2. í”„ë¡œì íŠ¸ ì—°ê²°: supabase link --project-ref YOUR_PROJECT_ID"
        echo "3. ìŠ¤í‚¤ë§ˆ ì ìš©: supabase db push"
        echo ""
        echo "ë˜ëŠ” Supabase ì›¹ ëŒ€ì‹œë³´ë“œì—ì„œ SQL ì—ë””í„°ë¥¼ ì‚¬ìš©í•˜ì—¬ database/schema.sql íŒŒì¼ ë‚´ìš©ì„ ì‹¤í–‰í•˜ì„¸ìš”."
    fi
fi

# Create startup script
echo ""
echo -e "${BLUE}ðŸš€ ì‹œìž‘ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì¤‘...${NC}"

cat > start-dev.sh << 'EOF'
#!/bin/bash

# WorkflowAI Development Startup Script

set -e

echo "ðŸš€ WorkflowAI ê°œë°œ í™˜ê²½ ì‹œìž‘ ì¤‘..."

# Check if .env exists
if [ ! -f .env ]; then
    echo "âŒ .env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. setup.shë¥¼ ë¨¼ì € ì‹¤í–‰í•´ì£¼ì„¸ìš”."
    exit 1
fi

# Load environment variables
export $(grep -v '^#' .env | xargs)

# Start MCP servers in background
echo "ðŸ¤– MCP ì„œë²„ ì‹œìž‘ ì¤‘..."
./scripts/run_mcp_servers.sh start

# Wait for MCP servers to be ready
sleep 5

# Start backend in background
echo "ðŸ”§ ë°±ì—”ë“œ ì„œë²„ ì‹œìž‘ ì¤‘..."
cd backend && python3 -m uvicorn main:app --reload --host 0.0.0.0 --port 8000 &
BACKEND_PID=$!
cd ..

# Wait for backend to be ready
sleep 3

# Start frontend
echo "ðŸŽ¨ í”„ë¡ íŠ¸ì—”ë“œ ì„œë²„ ì‹œìž‘ ì¤‘..."
npm run dev &
FRONTEND_PID=$!

echo ""
echo "âœ… ëª¨ë“  ì„œë¹„ìŠ¤ê°€ ì‹œìž‘ë˜ì—ˆìŠµë‹ˆë‹¤!"
echo "   ðŸŽ¨ í”„ë¡ íŠ¸ì—”ë“œ: http://localhost:3000"
echo "   ðŸ”§ ë°±ì—”ë“œ API: http://localhost:8000"
echo "   ðŸ¤– MCP ì„œë²„: 8001, 8002, 8003"
echo ""
echo "ì¢…ë£Œí•˜ë ¤ë©´ Ctrl+Cë¥¼ ëˆ„ë¥´ì„¸ìš”."

# Wait for user interrupt
trap 'echo ""; echo "ðŸ›‘ ì„œë¹„ìŠ¤ ì¢…ë£Œ ì¤‘..."; kill $BACKEND_PID $FRONTEND_PID; ./scripts/run_mcp_servers.sh stop; exit 0' INT

wait
EOF

chmod +x start-dev.sh

echo -e "${GREEN}âœ… ê°œë°œ ì‹œìž‘ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±: start-dev.sh${NC}"

# Create production docker-compose
cat > docker-compose.yml << 'EOF'
version: '3.8'

services:
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
    env_file:
      - .env
    depends_on:
      - backend

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    environment:
      - PYTHONPATH=/app
    env_file:
      - .env
    depends_on:
      - mcp-marketing
      - mcp-design
      - mcp-developer

  mcp-marketing:
    build:
      context: ./mcp-servers
      dockerfile: Dockerfile.marketing
    ports:
      - "8001:8001"
    env_file:
      - .env

  mcp-design:
    build:
      context: ./mcp-servers
      dockerfile: Dockerfile.design
    ports:
      - "8002:8002"
    env_file:
      - .env

  mcp-developer:
    build:
      context: ./mcp-servers
      dockerfile: Dockerfile.developer
    ports:
      - "8003:8003"
    env_file:
      - .env

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - frontend
      - backend
EOF

echo -e "${GREEN}âœ… Docker Compose ì„¤ì • íŒŒì¼ ìƒì„± ì™„ë£Œ${NC}"

# Final summary
echo ""
echo -e "${GREEN}ðŸŽ‰ WorkflowAI í™˜ê²½ ì„¤ì • ì™„ë£Œ!${NC}"
echo -e "${GREEN}==============================${NC}"
echo ""
echo -e "${BLUE}ë‹¤ìŒ ë‹¨ê³„:${NC}"
echo "1. í™˜ê²½ ë³€ìˆ˜ í™•ì¸: cat .env"
echo "2. ê°œë°œ ì„œë²„ ì‹œìž‘: ./start-dev.sh"
echo "3. ë¸Œë¼ìš°ì € ì—´ê¸°: http://localhost:3000"
echo ""
echo -e "${BLUE}ìœ ìš©í•œ ëª…ë ¹ì–´:${NC}"
echo "â€¢ MCP ì„œë²„ ìƒíƒœ: ./scripts/run_mcp_servers.sh status"
echo "â€¢ MCP ì„œë²„ ë¡œê·¸: ./scripts/run_mcp_servers.sh logs [server_name]"
echo "â€¢ ê°œë°œ ì„œë²„ ì¢…ë£Œ: Ctrl+C"
echo ""
echo -e "${YELLOW}ðŸ“‹ ì²´í¬ë¦¬ìŠ¤íŠ¸:${NC}"
echo "â–¡ Supabase í”„ë¡œì íŠ¸ ìƒì„± ë° ìŠ¤í‚¤ë§ˆ ì ìš©"
echo "â–¡ Clerk í”„ë¡œì íŠ¸ ì„¤ì •"
echo "â–¡ OpenAI API í‚¤ íšë“"
echo "â–¡ Stripe ê³„ì • ì„¤ì •"
echo "â–¡ ë„ë©”ì¸ ë° SSL ì¸ì¦ì„œ (í”„ë¡œë•ì…˜ìš©)"
echo ""
echo -e "${GREEN}ë¬¸ì œê°€ ìžˆìœ¼ë©´ logs í´ë”ë¥¼ í™•ì¸í•˜ê±°ë‚˜ GitHub Issuesì— ë¬¸ì˜í•˜ì„¸ìš”.${NC}"